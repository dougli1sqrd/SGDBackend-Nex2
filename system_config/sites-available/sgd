upstream frontend {
        server 127.0.0.1:6545;
}

upstream backend {
         server 127.0.0.1:6543;
}

server {
       listen 80;

       server_name _;
       access_log /var/log/sgd-backend.log;
       location / {
                proxy_set_header        Host $host:$server_port;
                proxy_set_header        X-Real-IP $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

                client_max_body_size    10m;
                client_body_buffer_size 128k;
                proxy_connect_timeout   60s;
                proxy_send_timeout      90s;
                proxy_read_timeout      90s;
                proxy_buffering         off;
                proxy_temp_file_write_size 64k;
                proxy_pass http://frontend/;
                proxy_redirect          off;

                # remove trailing slashes
                rewrite ^/(.*)/$ https://$host/$1 permanent;

                # force traffic from client to LB to use https
                if ($http_x_forwarded_proto != "https") {
                        rewrite ^(.*)$ https://$host$1 permanent;
                }
       }

       location /webservice/ {
                proxy_pass http://localhost:6543/;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }
}
